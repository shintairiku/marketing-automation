name: Database Migrations

on:
  push:
    branches: [main, develop]
    paths:
      - 'supabase/migrations/**'
      - '.github/workflows/db-migrations.yml'

jobs:
  migrate-development:
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: development
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      # config.toml の env(CLERK_DOMAIN) 等に必要な .env を生成
      - name: Create supabase env file
        run: |
          cat > supabase/.env << 'ENVEOF'
          CLERK_DOMAIN=placeholder.clerk.accounts.dev
          OPENAI_API_KEY=placeholder
          SUPABASE_AUTH_SMS_TWILIO_AUTH_TOKEN=placeholder
          S3_HOST=placeholder
          S3_REGION=placeholder
          S3_ACCESS_KEY=placeholder
          S3_SECRET_KEY=placeholder
          ENVEOF
          # trim leading whitespace
          sed -i 's/^[[:space:]]*//' supabase/.env

      - name: Link Supabase project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: Push migrations
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      # seed.sql を適用 (db push はseedを実行しないため手動)
      - name: Apply seed data
        run: |
          if [ -f supabase/seed.sql ]; then
            echo "Applying seed data..."
            supabase db execute --file supabase/seed.sql 2>/dev/null || \
            psql "postgresql://postgres.${{ secrets.SUPABASE_PROJECT_ID }}:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres" -f supabase/seed.sql || \
            echo "::warning::Seed data could not be applied automatically. Apply manually via SQL Editor."
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

  migrate-production:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Create supabase env file
        run: |
          cat > supabase/.env << 'ENVEOF'
          CLERK_DOMAIN=placeholder.clerk.accounts.dev
          OPENAI_API_KEY=placeholder
          SUPABASE_AUTH_SMS_TWILIO_AUTH_TOKEN=placeholder
          S3_HOST=placeholder
          S3_REGION=placeholder
          S3_ACCESS_KEY=placeholder
          S3_SECRET_KEY=placeholder
          ENVEOF
          sed -i 's/^[[:space:]]*//' supabase/.env

      - name: Link Supabase project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: Dry run
        run: supabase db push --dry-run
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: Push migrations
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
