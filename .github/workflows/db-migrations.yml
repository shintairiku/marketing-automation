name: Database Migrations

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'supabase/migrations/**'
      - '.github/workflows/db-migrations.yml'
  push:
    branches: [main, develop]
    paths:
      - 'supabase/migrations/**'
      - '.github/workflows/db-migrations.yml'

jobs:
  # ============================================================
  # PRæ™‚: dry-run ã§æ¤œè¨¼ã®ã¿ï¼ˆå®Ÿéš›ã«ã¯é©ç”¨ã—ãªã„ï¼‰
  # ============================================================
  validate-migration:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    environment: development
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Create supabase env file
        run: |
          cat > supabase/.env <<'EOF'
          CLERK_DOMAIN=placeholder.clerk.accounts.dev
          OPENAI_API_KEY=placeholder
          SUPABASE_AUTH_SMS_TWILIO_AUTH_TOKEN=placeholder
          S3_HOST=placeholder
          S3_REGION=placeholder
          S3_ACCESS_KEY=placeholder
          S3_SECRET_KEY=placeholder
          EOF
          sed -i 's/^[[:space:]]*//' supabase/.env

      - name: Link Supabase project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: Validate migrations (dry-run)
        run: |
          echo "ğŸ” Checking pending migrations..."
          supabase db push --dry-run
          echo "âœ… Migration validation passed"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

  # ============================================================
  # develop pushæ™‚: Dev Supabase ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
  # ============================================================
  migrate-development:
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: development
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Create supabase env file
        run: |
          cat > supabase/.env <<'EOF'
          CLERK_DOMAIN=placeholder.clerk.accounts.dev
          OPENAI_API_KEY=placeholder
          SUPABASE_AUTH_SMS_TWILIO_AUTH_TOKEN=placeholder
          S3_HOST=placeholder
          S3_REGION=placeholder
          S3_ACCESS_KEY=placeholder
          S3_SECRET_KEY=placeholder
          EOF
          sed -i 's/^[[:space:]]*//' supabase/.env

      - name: Link Supabase project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: Push migrations
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

  # ============================================================
  # main pushæ™‚: Prod Supabase ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ (dry-runå¾Œ)
  # ============================================================
  migrate-production:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Create supabase env file
        run: |
          cat > supabase/.env <<'EOF'
          CLERK_DOMAIN=placeholder.clerk.accounts.dev
          OPENAI_API_KEY=placeholder
          SUPABASE_AUTH_SMS_TWILIO_AUTH_TOKEN=placeholder
          S3_HOST=placeholder
          S3_REGION=placeholder
          S3_ACCESS_KEY=placeholder
          S3_SECRET_KEY=placeholder
          EOF
          sed -i 's/^[[:space:]]*//' supabase/.env

      - name: Link Supabase project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: Dry run
        run: supabase db push --dry-run
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: Push migrations
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
