### 管理者フロントエンド 実装マイルストーン計画

目的: 要件`requirement.md`を満たす管理UIをNext.jsフロントエンドに実装。`/admin`配下にレイアウト/ページ群を追加し、バックエンド`/admin` APIと接続。Supabase Realtimeの活用により、問い合わせ・進捗の即時反映を実現。

前提・方針
- ルーティング: `src/app/(admin)/admin/*` 直下に機能別ページ。共通レイアウト・ナビゲーション・認証ガード。
- 認証: Clerk/Supabase既存基盤でログイン済み前提。管理者判定はバックエンドの`/admin/health`で検証し、非管理者はダッシュボードへリダイレクト。
- UIキット: 既存`components/ui/*`、`display/sidebar.tsx`等を再利用。表はソート/フィルタ/ページネーション必須。CSV出力ボタン標準化。
- 状態管理: サーバーアクション＋SWR/React Query（いずれか）でデータ取得。リアルタイムはSupabase Channel購読。

---

### マイルストーン0: ベースUI/ガード（1〜2日）
目的: 管理エリアの骨格を最速で用意

タスク/チケット
1. レイアウト
   - `src/app/(admin)/admin/layout.tsx` 作成（サイドバー/ヘッダ/パンくず）。
   - メニュー: ダッシュボード、ユーザー、組織、サブスク、サポート、お知らせ、メッセージ、監視、設定。
2. 認証ガード
   - マウント時に`/api/admin/health`を叩き権限検証。403ならトップへ遷移。
3. 共通コンポーネント
   - テーブル（列の定義+ソート/フィルタ/ページネーション）、検索ボックス、CSVボタン、確認ダイアログ。

受け入れ基準
- 非管理者でアクセス時に保護される。メニュー遷移が動作。

---

### マイルストーン1: ユーザー・組織/サブスクUI（優先度: 高、3〜5日）
目的: 運用の土台となるブラウズ/検索/編集

ページ/機能
1. ユーザー管理（/admin/users）
   - 一覧（検索: email, plan, status、列表示カスタム、CSV）。
   - 詳細パネル（右スライドオーバー）でプロフィール/サブスク/課金情報の集約表示。
   - 編集モーダル（氏名/アバター、停止/再開）。
2. 組織管理（/admin/organizations）
   - 一覧+詳細（メンバー一覧/追加削除、所有者移行）。
3. サブスクリプション（/admin/subscriptions）
   - 個人/組織のプラン/期間/キャンセル状態の参照。操作は原則読み取り（Stripe連携の方針に従う）。

受け入れ基準
- 指定条件で高速に検索/ページング。編集後にトースト+即時反映。

---

### マイルストーン2: サポート管理UI（優先度: 高、4〜6日）
目的: チケット駆動の対応フローを効率化

ページ/機能（/admin/support）
- 一覧（状態/優先度/担当者/未読フィルタ、並び替え）。
- 詳細（スレッド表示、メッセージ投稿、AI案内の下書き提示、添付プレビュー）。
- チケット作成/担当アサイン/タグ、状態遷移（open→in_progress→resolved→closed）。
- Realtime購読（新規/更新/新着メッセージを即時反映）。
- ChatWork連携設定テスト（テスト通知ボタン）。

受け入れ基準
- 別クライアントから更新された内容が3秒以内でUI反映。

---

### マイルストーン3: お知らせ・投稿管理UI（優先度: 高、3〜5日）
目的: 記事作成→下書き→予約→公開の一連をUIで

ページ/機能（/admin/announcements）
- 一覧（ステータス/カテゴリ/公開日時フィルタ、並び替え）。
- 作成/編集（エディタ、プレビュー、カテゴリ、公開設定）。
- 予約公開（予約作成、予約一覧/取消）。
- 公開後の履歴参照・復元（複製して下書き作成）。

受け入れ基準
- 予約時刻に公開ステータスへ自動更新され、UIに反映。

---

### マイルストーン4: メッセージ・通知管理UI（優先度: 高、5〜8日）
目的: セグメント定義〜テンプレ〜配信の最低限ライン

ページ/機能（/admin/messages）
- テンプレ管理（一覧/作成/プレビュー）。
- キャンペーン作成（件名/本文、対象条件の簡易ビルダー: プラン, 最終利用日, 組織有無）。
- テスト送信、送信実行（進行状況/結果一覧、エラー詳細）。
- 開封/バウンス/スパムのWebhook反映表示。

受け入れ基準
- 小規模配信の完了とログ可視化。宛先重複排除が機能。

---

### マイルストーン5: 生成監視ダッシュボード（優先度: 中、3〜5日）
目的: 記事生成の進捗・失敗点の早期把握

ページ/機能（/admin/monitoring）
- プロセス一覧（`generated_articles_state`の状態, 進捗, 入力待ち）
- セッション詳細（`agent_log_sessions` 系のタイムライン、`agent_performance_metrics`ビューの可視化）。
- LLM/Tool呼び出し詳細（フィルタ/CSV）。

受け入れ基準
- セッションのボトルネックとエラー箇所を素早く辿れる。

---

### マイルストーン6: ダッシュボード（優先度: 中、2〜3日）
目的: 運用KPIの可視化

ページ/機能（/admin/dashboard）
- KPIカード（新規/アクティブ/売上/エラー/未読サポート）。
- 期間切替、トレンドチャート。

受け入れ基準
- 主要KPIが1秒以内に描画（サマリAPI+軽量キャッシュ）。

---

### マイルストーン7: 設定UI（優先度: 高、2〜3日）
目的: 運営情報・通知・既定値の管理

ページ/機能（/admin/settings）
- システム基本情報（会社情報、フッター文言）。
- 通知既定値（お知らせカテゴリ既定、送信元メール）。
- ChatWork/Webhook/外部メールAPIキー入力（暗号化保存はバックエンド）。

受け入れ基準
- 入力値が即時にAPIへ反映。危険操作は二重確認。

---

### 共通実装詳細
- デザイン/UX
  - 空状態/エラー/ローディングの3状態を統一デザインで。
  - テーブルは列ごとに`copy`/`export`補助を用意。
  - 破壊的操作は`AlertDialog`で確認文言+2段階承認。
- APIクライアント
  - `lib/api.ts`に`/admin`クライアント層を追加（型安全）。
- Realtime
  - `useEffect`で必要なチャンネル（support, announcements, processes）を購読し、SWR/Queryの`mutate`で反映。
- アクセシビリティ/国際化
  - ボタンラベル/ヘルプテキストをi18n対応想定で設計（初期は日本語固定）。

---

### 完了の定義（DoD）
- `requirement.md`高優先の全ページが操作可能で、主要フロー（検索→編集/作成→保存/配信/公開）が成立。
- リアルタイム更新が体感遅延無し（〜数秒）。
- 危険操作の誤操作防止UI（2段階確認/明確な警告）。


