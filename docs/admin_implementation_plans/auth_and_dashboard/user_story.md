# 要件ドキュメント

## はじめに

このドキュメントは、マーケティングオートメーションプラットフォームの管理者認証およびダッシュボードシステムを実装するための要件を概説します。本システムは、Google Workspace SSO 制限を用いた管理者向けの安全なアクセス制御、包括的なユーザーおよび組織管理機能、およびシステム監視用のダッシュボードを提供します。

管理者システムは、将来的にユーザー管理、組織管理、サブスクリプション管理、サポートチケット管理、告知、メッセージング、およびシステム設定を含む大規模な管理インターフェースの一部です。

## 要件

### 要件 1: Google Workspace SSO 認証

**ユーザーストーリー:** プラットフォーム管理者として、企業発行の Google Workspace アカウントのみで認証したい。これにより、アクセスが許可された担当者に限定され、個人の Gmail アカウントはブロックされます。

#### 受け入れ基準

1. 管理者がサインインを試みたとき、システムは Google Workspace SSO 認証のみを受け入れること。
2. ユーザーが個人の Gmail アカウント（@gmail.com）で認証しようとしたとき、システムは認証試行を拒否すること。
3. ユーザーが Google Workspace アカウントで認証したとき、システムはホステッドドメイン（hd）クレームが許可されたドメインリストと一致することを検証すること。
4. JWT トークン検証が有効な場合、システムはトークン署名とクレームを検証すること。
5. 許可されていないドメインが使用されたとき、システムは適切なエラーメッセージとともに 403 Forbidden を返すこと。
6. 認証が成功したとき、システムは管理者権限フラグを設定し、監査ログエントリを作成すること。

### 要件 2: 管理者認可ミドルウェア

**ユーザーストーリー:** システムアーキテクトとして、管理者エンドポイント向けの集中認可システムが欲しい。これにより、すべての管理者操作が適切に保護され、監査される。

#### 受け入れ基準

1. 管理者エンドポイントにアクセスされたとき、システムは `@require_admin` デコレータを使用して管理者権限を検証すること。
2. 管理者検証に失敗したとき、システムは 403 Forbidden を返すこと。
3. 管理者操作が実行されたとき、システムはすべての操作を自動的に監査システムに記録すること。
4. JWT トークンが無効または期限切れの場合、システムは適切なエラーコードでリクエストを拒否すること。
5. 管理者ミドルウェアが適用されたとき、システムはユーザーコンテキストを抽出し、エンドポイントで利用可能にすること。

### 要件 3: 管理ダッシュボード概要

**ユーザーストーリー:** プラットフォーム管理者として、ダッシュボードで主要なシステム指標とステータス情報を確認したい。これにより、プラットフォームの健全性とユーザー活動を一目で監視できる。

#### 受け入れ基準

1. 管理ダッシュボードにアクセスしたとき、システムは現在のアクティブユーザー数を表示すること。
2. ダッシュボードの指標を表示するとき、システムは新規ユーザー登録（日次、週次、月次）を表示すること。
3. サブスクリプションを監視するとき、システムはサブスクリプション状態の分布と収益指標を表示すること。
4. システム健全性を確認するとき、システムは API 使用統計とエラー率を表示すること。
5. 組織指標を表示するとき、システムは組織の作成およびメンバーシップの傾向を表示すること。
6. ダッシュボードデータにアクセスしたとき、システムは指標を自動的に 5 分ごとに更新すること。
7. ダッシュボードが読み込まれたとき、最適なユーザー体験のために 2 秒以内にデータを表示すること。

### 要件 4: 管理者ユーザー管理インターフェース

**ユーザーストーリー:** プラットフォーム管理者として、包括的なインターフェースでユーザーアカウントを管理したい。これにより、カスタマーサポートの要求やアカウント問題を効率的に処理できる。

#### 受け入れ基準

1. ユーザー管理ページを表示したとき、システムは検索可能な全ユーザーの一覧を表示すること。
2. ユーザーを検索するとき、システムはメール、ステータス、プラン、登録日のフィルタをサポートすること。
3. ユーザー詳細を表示したとき、システムはプロフィール情報、サブスクリプション状況、および組織メンバーシップを表示すること。
4. ユーザーアカウントを一時停止したとき、システムはアクセスを無効化し、Clerk 認証と同期すること。
5. ユーザーアカウントを再有効化したとき、システムはアクセスを復元し、関連するすべてのシステムを更新すること。
6. ユーザーデータをエクスポートするとき、システムは選択したユーザー情報を含む CSV ファイルを生成すること。
7. ユーザー操作を実行するとき、システムはすべての変更を監査システムに記録すること。

### 要件 5: 管理者組織管理

**ユーザーストーリー:** プラットフォーム管理者として、組織およびそのメンバーシップを管理したい。これにより、エンタープライズ顧客の要望に対応し、組織の問題を解決できる。

#### 受け入れ基準

1. 組織を表示したとき、システムはメンバー数とサブスクリプション状況を含む一覧を表示すること。
2. 組織メンバーを管理するとき、システムはメンバーの追加、削除、ロール変更を許可すること。
3. 組織詳細を表示するとき、システムはサブスクリプション情報、メンバー一覧、および利用統計を表示すること。
4. 組織の所有権を移転するとき、システムは所有権を更新し、データ整合性を維持すること。
5. 組織を削除するとき、システムはメンバーの再割り当てとデータクリーンアップを処理すること。
6. Clerk と同期するとき、システムは Clerk の組織情報とデータベースレコードの一貫性を維持すること。

### 要件 6: 監査ログシステム

**ユーザーストーリー:** コンプライアンス担当者として、すべての管理操作が詳細にログされることを望む。これにより、セキュリティ監査トレイルを維持し、問題を調査できる。

#### 受け入れ基準

1. いかなる管理操作が行われたとき、システムは詳細な監査ログエントリを作成すること。
2. 管理操作をログに記録するとき、システムはタイムスタンプ、管理者ユーザー ID、操作タイプ、対象リソース、および行われた変更を記録すること。
3. 監査ログが作成されるとき、システムは IP アドレス、ユーザーエージェント、およびセッション情報を含めること。
4. 監査ログを表示するとき、システムはフィルタリングと検索機能を提供すること。
5. 監査データが保存されるとき、システムは改ざん防止のロギングと適切な保持ポリシーを確保すること。
6. 重要な操作が発生したとき、システムはセキュリティ監視のためにリアルタイムアラートを生成すること。

### 要件 7: 管理 API インフラストラクチャ

**ユーザーストーリー:** フロントエンド開発者として、一貫性があり十分に文書化された管理 API が欲しい。これにより、信頼できる管理インターフェースを構築できる。

#### 受け入れ基準

1. 管理 API が呼び出されたとき、システムは適切な HTTP ステータスコードとともに一貫したレスポンス形式を返すこと。
2. API エラーが発生したとき、システムは機密情報を露出せずに詳細なエラーメッセージを提供すること。
3. API ドキュメントが生成されるとき、システムは自動的に OpenAPI 仕様を作成すること。
4. レート制限が適用されたとき、システムは通常の操作を許容しつつ管理エンドポイントを濫用から保護すること。
5. API レスポンスが返されるとき、システムは管理フロントエンドアクセスのために適切な CORS ヘッダーを含めること。

### 要件 8: システム構成管理

**ユーザーストーリー:** プラットフォーム管理者として、管理インターフェースを通じてシステム全体の設定を管理したい。これにより、コードデプロイなしにプラットフォームを構成できる。

#### 受け入れ基準

1. システム設定にアクセスしたとき、システムはカテゴリ別に整理された設定可能なパラメータを表示すること。
2. 設定を更新するとき、システムは入力値を検証し、即時フィードバックを提供すること。
3. 設定が変更されたとき、可能な場合はシステム再起動を必要とせずに変更を適用すること。
4. 構成が更新されたとき、システムはバージョン履歴を維持し、ロールバック機能を提供すること。
5. 設定がユーザー体験に影響する場合、システムは変更を適用する前にプレビュー機能を提供すること。

### 要件 9: セキュリティとパフォーマンス

**ユーザーストーリー:** セキュリティ管理者として、管理システムが企業向けのセキュリティ標準を満たすことを望む。これにより、機微な管理操作が適切に保護される。

#### 受け入れ基準

1. 管理セッションが作成されたとき、システムは適切なセッションタイムアウトと更新を実装すること。
2. 機微な操作が行われるとき、システムは追加の確認ダイアログを要求すること。
3. データベースクエリが実行されるとき、システムは適切なインデックス作成とクエリ最適化を使用すること。
4. 管理ページが読み込まれるとき、システムはリクエストの 95% を 500ms 未満で処理すること。
5. 同時に複数の管理者ユーザーがアクセスするとき、システムは最大 10 件の同時管理セッションを処理できること。
6. セキュリティ脆弱性が検出されたとき、システムは重大度の高い脆弱性をゼロにすること。

### 要件 10: 統合とデータ整合性

**ユーザーストーリー:** システム管理者として、すべての統合サービス間でデータ整合性が維持されることを望む。これにより、管理操作が適切に同期される。

#### 受け入れ基準

1. ユーザーデータが変更されたとき、システムは Clerk 認証サービスと変更を同期すること。
2. 組織に変更が発生したとき、システムは Clerk の組織情報とデータベースレコードの一貫性を維持すること。
3. サブスクリプションデータにアクセスしたとき、システムは Stripe 統合からの最新情報を表示すること。
4. データ不整合が検出されたとき、システムは突合ツールとアラートを提供すること。
5. 外部サービス障害が発生したとき、システムはエラーを適切に処理し、リトライ機能を提供すること。
