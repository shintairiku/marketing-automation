<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Article Generator Test (v3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* カスタムスタイル */
        #messages div { margin-bottom: 8px; padding: 8px; border-radius: 4px; word-wrap: break-word; }
        .server-msg { background-color: #e0f2fe; border-left: 4px solid #3b82f6; } /* Server messages: light blue */
        .client-msg { background-color: #dcfce7; text-align: right; border-right: 4px solid #16a34a; } /* Client messages: light green */
        .error-msg { background-color: #fee2e2; border-left: 4px solid #ef4444; color: #b91c1c; } /* Error messages: light red */
        .info-msg { background-color: #f3f4f6; border-left: 4px solid #6b7280; color: #4b5563; font-style: italic; font-size: 0.9em;} /* Info messages: light gray */
        .user-input-req-msg { background-color: #fef9c3; border-left: 4px solid #f59e0b; } /* User input request log: light yellow */

        /* Final article preview area */
        #final-article-preview { border: 1px solid #ccc; padding: 15px; margin-top: 15px; max-height: 500px; overflow-y: auto; background-color: #f9f9f9; }
        /* Code block styling within messages */
        pre { white-space: pre-wrap; word-wrap: break-word; background-color: #f4f4f5; padding: 10px; border-radius: 5px; margin-top: 5px; font-family: monospace; font-size: 0.9em; max-height: 300px; overflow-y: auto;}
        code { font-family: monospace; }
        /* Label styling */
        label { font-weight: 500; }
        /* Disabled button styling */
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        /* Tab styling */
        .tab-button { padding: 8px 16px; cursor: pointer; border: 1px solid #ccc; border-bottom: none; background-color: #f0f0f0; border-radius: 4px 4px 0 0; margin-right: 2px;}
        .tab-button.active { background-color: white; border-bottom: 1px solid white; position: relative; top: 1px;}
        .tab-content { border: 1px solid #ccc; padding: 15px; border-radius: 0 4px 4px 4px; }
        /* User interaction panel styling */
        #user-interaction { border: 2px solid #f59e0b; background-color: #fefce8; }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 font-sans">
    <div class="container mx-auto bg-white p-6 rounded-lg shadow-md max-w-4xl">
        <h1 class="text-2xl font-bold mb-6 text-center">WebSocket Article Generator Test</h1>

        <div class="mb-6 p-4 border rounded-md bg-gray-50">
            <h2 class="text-lg font-semibold mb-3">1. 接続 (Connection)</h2>
            <div class="mb-3">
                <label for="ws_url" class="block text-sm font-medium text-gray-700">WebSocket URL:</label>
                <input type="text" id="ws_url" value="ws://localhost:8008/articles/ws/generate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
            <div>
                <button id="connectBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2 transition duration-150 ease-in-out">接続 (Connect)</button>
                <button id="disconnectBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out" disabled>切断 (Disconnect)</button>
                <span id="connectionStatus" class="ml-4 text-sm font-medium text-gray-500">未接続 (Disconnected)</span>
            </div>
        </div>

        <div class="mb-6 p-4 border rounded-md bg-gray-50">
            <h2 class="text-lg font-semibold mb-3">2. 初期リクエスト (Initial Request)</h2>
            <div class="mb-1 border-b border-gray-200">
                <nav class="-mb-px flex" aria-label="Tabs">
                    <button id="tab-form" class="tab-button active" onclick="switchTab('form')">フォーム入力 (Form Input)</button>
                    <button id="tab-json" class="tab-button" onclick="switchTab('json')">JSON入力 (Raw JSON)</button>
                </nav>
            </div>

            <div id="content-form" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="initial_keywords" class="block text-sm font-medium text-gray-700">キーワード (カンマ区切り):</label>
                        <input type="text" id="initial_keywords" value="札幌, 注文住宅, 自然素材, 子育て" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="target_age_group" class="block text-sm font-medium text-gray-700">ターゲット年代層:</label>
                        <select id="target_age_group" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="">指定なし</option>
                            <option value="10代">10代</option>
                            <option value="20代" selected>20代</option>
                            <option value="30代">30代</option>
                            <option value="40代">40代</option>
                            <option value="50代">50代</option>
                            <option value="60代">60代</option>
                            <option value="70代以上">70代以上</option>
                        </select>
                    </div>
                    <div>
                        <label for="persona_type" class="block text-sm font-medium text-gray-700">ペルソナ属性:</label>
                        <select id="persona_type" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="">指定なし</option>
                            <option value="主婦">主婦</option>
                            <option value="学生">学生</option>
                            <option value="社会人" selected>社会人</option>
                            <option value="自営業">自営業</option>
                            <option value="経営者・役員">経営者・役員</option>
                            <option value="退職者">退職者</option>
                            <option value="その他">その他（独自ペルソナを設定）</option>
                        </select>
                    </div>
                    <div>
                        <label for="custom_persona" class="block text-sm font-medium text-gray-700">独自ペルソナ設定 (属性で「その他」選択時):</label>
                        <input type="text" id="custom_persona" placeholder="例: 特定の趣味を持つエンジニア" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="target_length" class="block text-sm font-medium text-gray-700">目標文字数 (任意):</label>
                        <input type="number" id="target_length" value="3000" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="num_theme_proposals" class="block text-sm font-medium text-gray-700">テーマ提案数:</label>
                        <input type="number" id="num_theme_proposals" value="3" min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                     <div>
                        <label for="num_research_queries" class="block text-sm font-medium text-gray-700">リサーチクエリ数 (任意):</label>
                        <input type="number" id="num_research_queries" value="3" min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="num_persona_examples" class="block text-sm font-medium text-gray-700">具体的なペルソナ生成数 (任意):</label>
                        <input type="number" id="num_persona_examples" value="3" min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
                 <div class="mb-4">
                    <label for="company_name" class="block text-sm font-medium text-gray-700">会社名 (任意):</label>
                    <input type="text" id="company_name" value="株式会社ナチュラルホームズ札幌" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                 <div class="mb-4">
                    <label for="company_description" class="block text-sm font-medium text-gray-700">会社概要 (任意):</label>
                    <textarea id="company_description" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">札幌を拠点に、自然素材を活かした健康で快適な注文住宅を提供しています。</textarea>
                </div>
                 <div class="mb-4">
                    <label for="company_style_guide" class="block text-sm font-medium text-gray-700">スタイルガイド (任意):</label>
                    <textarea id="company_style_guide" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">専門用語を避け、温かみのある丁寧語（ですます調）で。子育て世代の読者に寄り添い、安心感を与えるようなトーンを心がける。</textarea>
                </div>
                <button id="sendFormRequestBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out" disabled>リクエスト送信 (Send Request from Form)</button>
            </div>

            <div id="content-json" class="tab-content hidden">
                <label for="initial_request_json" class="block text-sm font-medium text-gray-700">初期リクエスト (Raw JSON):</label>
                <textarea id="initial_request_json" rows="12" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm font-mono">{
"initial_keywords": ["札幌", "注文住宅", "自然素材", "子育て"],
"target_age_group": "30代",
"persona_type": "主婦",
"custom_persona": "札幌中心部から少し離れた郊外に住み、夫と小学生の子供2人と暮らす。週末は家族でアウトドアを楽しむことが多い。",
"target_length": 3000,
"num_theme_proposals": 3,
"num_research_queries": 3,
"num_persona_examples": 3,
"company_name": "株式会社ナチュラルホームズ札幌",
"company_description": "札幌を拠点に、自然素材を活かした健康で快適な注文住宅を提供しています。",
"company_style_guide": "専門用語を避け、温かみのある丁寧語（ですます調）で。子育て世代の読者に寄り添い、安心感を与えるようなトーンを心がける。"
}</textarea>
                <button id="sendJsonRequestBtn" class="mt-2 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out" disabled>JSONリクエスト送信 (Send Raw JSON Request)</button>
            </div>
        </div>

        <div class="mb-6 p-4 border rounded-md bg-gray-50">
             <h2 class="text-lg font-semibold mb-3">3. 処理ログとインタラクション (Process Log & Interaction)</h2>
             <div id="messages" class="h-96 overflow-y-auto border border-gray-300 p-4 rounded-md bg-white mb-4 shadow-inner">
                </div>

            <div id="user-interaction" class="hidden mt-4 p-4 rounded-md shadow">
                <h3 class="text-lg font-semibold text-yellow-800 mb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    ユーザー入力が必要です (User Input Required)
                </h3>
                <div id="user-prompt" class="text-yellow-700 mb-3"></div>
                <div id="interaction-options" class="space-y-3">
                    </div>
            </div>
        </div>

        <!-- Streaming Preview Section START -->
        <div id="streaming-preview-container" class="hidden mt-6 p-4 border rounded-md bg-gray-50">
            <h2 class="text-lg font-semibold mb-3">リアルタイムプレビュー (Streaming Preview)</h2>
            <div id="streaming-preview" class="prose max-w-none border border-gray-300 p-4 rounded-md bg-white shadow-inner min-h-[200px] max-h-[400px] overflow-y-auto">
                <!-- Streaming content will appear here -->
            </div>
        </div>
        <!-- Streaming Preview Section END -->

        <div id="final-article-container" class="hidden mt-6 p-4 border rounded-md bg-gray-50">
            <h2 class="text-lg font-semibold mb-3">4. 完成記事 (Final Article)</h2>
            <button id="copyHtmlBtn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded mb-3 transition duration-150 ease-in-out">HTMLをコピー (Copy HTML)</button>
             <div id="final-article-preview" class="prose max-w-none">
                 </div>
        </div>

    </div>

    <script>
        // --- DOM Element References ---
        const wsUrlInput = document.getElementById('ws_url');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const connectionStatusSpan = document.getElementById('connectionStatus');

        const initialKeywordsInput = document.getElementById('initial_keywords');
        const targetAgeGroupInput = document.getElementById('target_age_group');
        const personaTypeInput = document.getElementById('persona_type');
        const customPersonaInput = document.getElementById('custom_persona');
        const targetLengthInput = document.getElementById('target_length');
        const numThemeProposalsInput = document.getElementById('num_theme_proposals');
        const numResearchQueriesInput = document.getElementById('num_research_queries');
        const numPersonaExamplesInput = document.getElementById('num_persona_examples');
        const companyNameInput = document.getElementById('company_name');
        const companyDescriptionInput = document.getElementById('company_description');
        const companyStyleGuideInput = document.getElementById('company_style_guide');
        const sendFormRequestBtn = document.getElementById('sendFormRequestBtn');

        const initialRequestJsonText = document.getElementById('initial_request_json');
        const sendJsonRequestBtn = document.getElementById('sendJsonRequestBtn');

        const messagesDiv = document.getElementById('messages');
        const userInteractionDiv = document.getElementById('user-interaction');
        const userPromptDiv = document.getElementById('user-prompt');
        const interactionOptionsDiv = document.getElementById('interaction-options');
        const finalArticleContainer = document.getElementById('final-article-container');
        const finalArticlePreviewDiv = document.getElementById('final-article-preview');
        const copyHtmlBtn = document.getElementById('copyHtmlBtn');

        const streamingPreviewContainer = document.getElementById('streaming-preview-container');
        const streamingPreviewDiv = document.getElementById('streaming-preview');

        const tabForm = document.getElementById('tab-form');
        const tabJson = document.getElementById('tab-json');
        const contentForm = document.getElementById('content-form');
        const contentJson = document.getElementById('content-json');

        // --- State Variables ---
        let websocket = null; // Holds the WebSocket object
        let currentExpectedResponseType = null; // Stores the expected response_type for the next client message
        let finalHtmlContent = ''; // Stores the final generated HTML
        let messageCounter = 0; // Counter for unique message IDs

        // --- Tab Switching Logic ---
        function switchTab(tabName) {
            if (tabName === 'form') {
                tabForm.classList.add('active');
                tabJson.classList.remove('active');
                contentForm.classList.remove('hidden');
                contentJson.classList.add('hidden');
            } else {
                tabForm.classList.remove('active');
                tabJson.classList.add('active');
                contentForm.classList.add('hidden');
                contentJson.classList.remove('hidden');
            }
        }

        // --- Logging Function ---
        function logMessage(message, type = 'info', isJson = false) {
            const div = document.createElement('div');
            messageCounter++;
            div.id = `msg-${messageCounter}`;

            let typeClass = 'info-msg';
            let prefix = '[INFO]';
            if (type === 'server') { typeClass = 'server-msg'; prefix = '[SERVER]'; }
            else if (type === 'client') { typeClass = 'client-msg'; prefix = '[CLIENT]'; }
            else if (type === 'error') { typeClass = 'error-msg'; prefix = '[ERROR]'; }
            else if (type === 'user-input-req') { typeClass = 'user-input-req-msg'; prefix = '[INPUT REQ]'; }

            div.className = typeClass;

            // Format JSON nicely if applicable
            if (isJson) {
                 try {
                    // Ensure message is an object before stringifying
                    const objToLog = (typeof message === 'string') ? JSON.parse(message) : message;
                    div.innerHTML = `<strong>${prefix}</strong> <pre><code>${JSON.stringify(objToLog, null, 2)}</code></pre>`;
                } catch (e) {
                     // If parsing fails (e.g., already a string), log as plain text
                     div.innerHTML = `<strong>${prefix}</strong> (JSON Parse Error or String) ${String(message).replace(/</g, "&lt;").replace(/>/g, "&gt;")}`;
                }
            } else {
                // Log plain text message (with basic HTML escaping)
                div.innerHTML = `<strong>${prefix}</strong> ${String(message).replace(/</g, "&lt;").replace(/>/g, "&gt;")}`;
            }

            messagesDiv.appendChild(div);
            // Scroll to the bottom of the message log with a slight delay
            setTimeout(() => {
                 messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 50);
        }

        // --- UI Update Functions ---
        function updateConnectionStatus(status, color = 'text-gray-500') {
            connectionStatusSpan.textContent = status;
            connectionStatusSpan.className = `ml-4 text-sm font-medium ${color}`;
        }

        function enableButtonsOnConnect(connected) {
            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
            // Only enable send buttons if connected
            sendFormRequestBtn.disabled = !connected;
            sendJsonRequestBtn.disabled = !connected;
            // Input fields are handled by disableInitialInput
        }

        // Disable/Enable initial request input fields and buttons during processing
        function disableInteractionElements(disabled) {
            // Disable initial request form/JSON inputs and send buttons
            initialKeywordsInput.disabled = disabled;
            targetAgeGroupInput.disabled = disabled;
            personaTypeInput.disabled = disabled;
            customPersonaInput.disabled = disabled;
            targetLengthInput.disabled = disabled;
            numThemeProposalsInput.disabled = disabled;
            numResearchQueriesInput.disabled = disabled;
            numPersonaExamplesInput.disabled = disabled;
            companyNameInput.disabled = disabled;
            companyDescriptionInput.disabled = disabled;
            companyStyleGuideInput.disabled = disabled;
            initialRequestJsonText.disabled = disabled;
            // Disable send buttons if processing or not connected
            const isConnected = websocket && websocket.readyState === WebSocket.OPEN;
            sendFormRequestBtn.disabled = disabled || !isConnected;
            sendJsonRequestBtn.disabled = disabled || !isConnected;

            // Disable user interaction buttons (theme selection, approval) if processing
            const interactionButtons = interactionOptionsDiv.querySelectorAll('button');
            interactionButtons.forEach(button => button.disabled = disabled);
        }

        // --- WebSocket Logic ---
        connectBtn.onclick = () => {
            const url = wsUrlInput.value;
            if (!url) {
                logMessage('WebSocket URLを入力してください。(Please enter a WebSocket URL.)', 'error');
                return;
            }
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                logMessage('すでに接続されています。(Already connected.)');
                return;
            }

            logMessage(`${url} に接続中... (Connecting to ${url}...)`);
            updateConnectionStatus('接続中... (Connecting...)', 'text-yellow-500');
            websocket = new WebSocket(url);

            websocket.onopen = (event) => {
                logMessage('WebSocket 接続完了！ (WebSocket Connected!)');
                updateConnectionStatus('接続済み (Connected)', 'text-green-600');
                enableButtonsOnConnect(true);
                disableInteractionElements(false); // Enable inputs on connect
                // Clear previous logs and results on new connection
                messagesDiv.innerHTML = '';
                hideInteraction();
                finalArticleContainer.classList.add('hidden');
                finalArticlePreviewDiv.innerHTML = '';
                streamingPreviewContainer.classList.add('hidden');
                streamingPreviewDiv.innerHTML = '';
                finalHtmlContent = '';
            };

            websocket.onmessage = (event) => {
                let data;
                try {
                    data = JSON.parse(event.data);
                    logMessage(data, 'server', true); // Log raw JSON
                } catch (e) {
                    logMessage(`メッセージの解析エラー: ${e}`, 'error');
                    logMessage(`生データ: ${event.data}`, 'info');
                    console.error("Error parsing message:", e, "Raw data:", event.data);
                    return; // Stop processing if JSON is invalid
                }

                // Process server event messages
                if (data.type === 'server_event' && data.payload) {
                    const payload = data.payload;
                    handleServerPayload(payload);
                } else {
                    logMessage(`不明なメッセージタイプを受信: ${data.type}`, 'info');
                }
            };

            websocket.onerror = (event) => {
                logMessage('WebSocket エラー発生。コンソールを確認してください。(WebSocket Error. Check console.)', 'error');
                console.error("WebSocket Error: ", event);
                updateConnectionStatus('エラー (Error)', 'text-red-600');
                enableButtonsOnConnect(false);
                disableInteractionElements(false); // Re-enable inputs on error
                hideInteraction();
            };

            websocket.onclose = (event) => {
                logMessage(`WebSocket 切断: Code=${event.code}, Reason=${event.reason || 'N/A'}`, 'info');
                websocket = null;
                updateConnectionStatus('未接続 (Disconnected)', 'text-gray-500');
                enableButtonsOnConnect(false);
                disableInteractionElements(false); // Re-enable inputs on close
                hideInteraction();
            };
        };

        // --- Centralized Server Payload Handler ---
        function handleServerPayload(payload) {
            // 1. Check for User Input Request FIRST
            if (payload.request_type && payload.data) {
                logMessage(`サーバーがユーザー入力を要求: ${payload.request_type}`, 'user-input-req');
                displayInteraction(payload.request_type, payload.data);
                disableInteractionElements(false); // Ensure interaction buttons are enabled
            }
            // 2. Check for Error
            else if (payload.error_message) {
                logMessage(`エラー (${payload.step || 'unknown'}): ${payload.error_message}`, 'error');
                disableInteractionElements(false); // Re-enable inputs on error
                hideInteraction(); // Hide interaction panel on error
            }
            // 3. Check for Final Result
            else if (payload.final_html_content) {
                logMessage('記事生成完了！ (Article generation complete!)', 'info');
                displayFinalArticle(payload.title, payload.final_html_content);
                disableInteractionElements(false); // Re-enable inputs on completion
            }
            // 4. Check for Status Updates (but not errors or final results)
            else if (payload.step && payload.message) {
                 logMessage(`ステータス: ${payload.step} - ${payload.message}`, 'info');
                 // Keep interaction elements disabled during general status updates
                 if (payload.step !== 'finished') { // Re-enable only if finished without error/final result (e.g., cancelled)
                     disableInteractionElements(true);
                 } else {
                     disableInteractionElements(false);
                 }
            }
            // 5. Check for Section Generation (Chunk or Complete)
            else if (payload.html_content_chunk !== undefined) {
                displayStreamingChunk(payload.section_index, payload.heading, payload.html_content_chunk, payload.is_complete);
                if (payload.is_complete) {
                    logMessage(`セクション ${payload.section_index + 1} (${payload.heading}) 生成完了。(Section generation complete.)`, 'info');
                }
                disableInteractionElements(true); // Keep disabled during writing
            }
            // 6. Check for Research Progress
            else if (payload.query_index !== undefined && payload.total_queries !== undefined) {
                 logMessage(`リサーチ中: クエリ ${payload.query_index + 1}/${payload.total_queries} - "${payload.query}"`, 'info');
                 disableInteractionElements(true); // Keep disabled during research
            }
             // 7. Check for Research Complete (Report generated)
            else if (payload.report && payload.report.overall_summary !== undefined) {
                 logMessage(`リサーチ完了。レポート生成。(Research complete. Report generated.)`, 'info');
                 disableInteractionElements(true); // Keep disabled before outline generation/approval
            }
            // 8. Handle other informational payloads (like plan/outline details IF NOT part of user_input_request)
            // Note: These might often be included within the 'user_input_request' data instead.
            else if (payload.plan && payload.plan.queries !== undefined) {
                 logMessage(`リサーチ計画情報受信。(Research plan info received.)`, 'info');
                 // Usually part of approval request, so interaction elements likely disabled here anyway.
                 disableInteractionElements(true);
            } else if (payload.outline && payload.outline.sections !== undefined) {
                 logMessage(`アウトライン情報受信。(Outline info received.)`, 'info');
                 // Usually part of approval request.
                 disableInteractionElements(true);
            }
            // 9. Log Unknown Payloads
            else {
                logMessage(`不明または情報提供ペイロード受信。(Unknown or informational payload received.)`, 'info');
                console.log("Unknown or info payload:", payload);
                // Assume processing is ongoing unless proven otherwise
                disableInteractionElements(true);
            }
        }

        function displayStreamingChunk(sectionIndex, heading, chunk, isComplete) {
            streamingPreviewContainer.classList.remove('hidden');
            let sectionDiv = document.getElementById(`streaming-section-${sectionIndex}`);
            if (!sectionDiv) {
                sectionDiv = document.createElement('div');
                sectionDiv.id = `streaming-section-${sectionIndex}`;
                sectionDiv.className = 'mb-4 p-4 border rounded-md bg-gray-100';
                sectionDiv.innerHTML = `<h3 class="text-lg font-semibold mb-2">${heading}</h3>`;
                streamingPreviewDiv.appendChild(sectionDiv);
            }
            sectionDiv.innerHTML += chunk;
            if (isComplete) {
                sectionDiv.innerHTML += '<p class="text-green-600 mt-2">セクション完了 (Section Complete)</p>';
            }
        }

        disconnectBtn.onclick = () => {
             if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.close();
                logMessage('切断中... (Disconnecting...)');
            } else {
                logMessage('接続されていません。(Not connected.)');
            }
        };

        // --- Initial Request Sending Logic ---
        function sendInitialRequest(requestData) {
             if (websocket && websocket.readyState === WebSocket.OPEN) {
                try {
                    const messageStr = JSON.stringify(requestData);
                    websocket.send(messageStr);
                    logMessage(requestData, 'client', true); // Log sent JSON
                    disableInteractionElements(true); // Disable inputs *during* processing
                    // Clear previous results when starting new generation
                    finalArticleContainer.classList.add('hidden');
                    finalArticlePreviewDiv.innerHTML = '';
                    streamingPreviewContainer.classList.add('hidden');
                    streamingPreviewDiv.innerHTML = '';
                    finalHtmlContent = '';
                    hideInteraction(); // Hide any leftover interaction panel
                } catch (e) {
                    logMessage(`初期リクエストの送信失敗: ${e}`, 'error');
                    disableInteractionElements(false); // Re-enable if sending failed
                }
            } else {
                logMessage('WebSocketが接続されていません。(WebSocket is not connected.)', 'error');
            }
        }

        function enableRequestButtons(enabled) {
            sendFormRequestBtn.disabled = !enabled;
            sendJsonRequestBtn.disabled = !enabled;
        }

        function toggleInitialInputsDisabled(disabled) {
            initialKeywordsInput.disabled = disabled;
            targetAgeGroupInput.disabled = disabled;
            personaTypeInput.disabled = disabled;
            customPersonaInput.disabled = disabled;
            targetLengthInput.disabled = disabled;
            numThemeProposalsInput.disabled = disabled;
            numResearchQueriesInput.disabled = disabled;
            numPersonaExamplesInput.disabled = disabled;
            companyNameInput.disabled = disabled;
            companyDescriptionInput.disabled = disabled;
            companyStyleGuideInput.disabled = disabled;
            initialRequestJsonText.disabled = disabled;
        }

        sendFormRequestBtn.addEventListener('click', () => {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                logMessage('WebSocket is not connected.', 'error');
                return;
            }
            const keywords = initialKeywordsInput.value.split(',').map(k => k.trim()).filter(k => k);
            const targetLength = parseInt(targetLengthInput.value, 10);
            const numThemeProposals = parseInt(numThemeProposalsInput.value, 10);
            const numResearchQueries = parseInt(numResearchQueriesInput.value, 10);
            const numPersonaExamples = parseInt(numPersonaExamplesInput.value, 10);

            const requestData = {
                initial_keywords: keywords,
                target_age_group: targetAgeGroupInput.value || null,
                persona_type: personaTypeInput.value || null,
                custom_persona: customPersonaInput.value || null,
                target_length: isNaN(targetLength) ? null : targetLength,
                num_theme_proposals: numThemeProposals || 3,
                num_research_queries: numResearchQueries || 3,
                num_persona_examples: numPersonaExamples || 3,
                company_name: companyNameInput.value || null,
                company_description: companyDescriptionInput.value || null,
                company_style_guide: companyStyleGuideInput.value || null
            };

            for (const key in requestData) {
                if (requestData[key] === null || requestData[key] === '') {
                    delete requestData[key];
                }
            }
            if (requestData.initial_keywords && requestData.initial_keywords.length === 0) {
                delete requestData.initial_keywords;
            }

            logMessage(requestData, 'client', true);
            websocket.send(JSON.stringify(requestData));
            toggleInitialInputsDisabled(true);
            userInteractionDiv.classList.add('hidden');
        });

        sendJsonRequestBtn.addEventListener('click', () => {
             try {
                const requestData = JSON.parse(initialRequestJsonText.value);
                sendInitialRequest(requestData);
            } catch (e) {
                logMessage(`Raw Request内のJSONが無効です: ${e}`, 'error');
            }
        });

        // --- User Interaction Handling ---
        function displayInteraction(requestType, data) {
            currentExpectedResponseType = requestType;
            userInteractionDiv.classList.remove('hidden');
            interactionOptionsDiv.innerHTML = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            disableInteractionElements(false);

            // --- Handle 'select_persona' request (New) ---
            if (requestType === UserInputType.SELECT_PERSONA) {
                userPromptDiv.textContent = "以下の具体的なペルソナ案から1つ選択してください。各ペルソナは編集も可能です。";
                const personas = data.personas;
                if (personas && personas.length > 0) {
                    personas.forEach((persona, index) => {
                        const div = document.createElement('div');
                        div.className = 'mb-3 p-3 border rounded bg-gray-50';

                        const radioId = `persona_option_${index}`;
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = 'persona_selection';
                        radio.id = radioId;
                        radio.value = persona.id;
                        radio.className = 'mr-2';
                        if (index === 0) radio.checked = true;

                        const label = document.createElement('label');
                        label.htmlFor = radioId;
                        label.className = 'font-semibold';
                        label.textContent = `ペルソナ案 ${persona.id + 1}`;

                        const descriptionTextareaId = `persona_desc_edit_${persona.id}`;
                        const descriptionTextarea = document.createElement('textarea');
                        descriptionTextarea.id = descriptionTextareaId;
                        descriptionTextarea.value = persona.description;
                        descriptionTextarea.rows = 3;
                        descriptionTextarea.className = 'mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm';
                        
                        div.appendChild(radio);
                        div.appendChild(label);
                        div.appendChild(descriptionTextarea);
                        interactionOptionsDiv.appendChild(div);
                    });

                    // 選択して進むボタン
                    const selectButton = document.createElement('button');
                    selectButton.textContent = 'このペルソナで決定';
                    selectButton.className = 'bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2';
                    selectButton.onclick = () => {
                        const selectedRadio = document.querySelector('input[name=\"persona_selection\"]:checked');
                        if (selectedRadio) {
                            sendClientResponse(UserInputType.SELECT_PERSONA, { selected_id: parseInt(selectedRadio.value) });
                        }
                    };
                    interactionOptionsDiv.appendChild(selectButton);

                    // 編集して進むボタン
                    const editButton = document.createElement('button');
                    editButton.textContent = '編集した内容で決定';
                    editButton.className = 'bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded mr-2';
                    editButton.onclick = () => {
                        const selectedRadio = document.querySelector('input[name=\"persona_selection\"]:checked');
                        if (selectedRadio) {
                            const personaId = selectedRadio.value;
                            const editedDescription = document.getElementById(`persona_desc_edit_${personaId}`).value;
                            sendClientResponse(UserInputType.EDIT_AND_PROCEED, { 
                                edited_content: { id: parseInt(personaId), description: editedDescription }
                            }); 
                        }
                    };
                    interactionOptionsDiv.appendChild(editButton);

                    // 再生成ボタン
                    const regenerateButton = document.createElement('button');
                    regenerateButton.textContent = 'ペルソナを再生成';
                    regenerateButton.className = 'bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded';
                    regenerateButton.onclick = () => {
                        sendClientResponse(UserInputType.REGENERATE, {});
                    };
                    interactionOptionsDiv.appendChild(regenerateButton);

                } else {
                    userPromptDiv.textContent = "ペルソナ案がありませんでした。";
                }
            }
            // --- Handle 'select_theme' request ---
            else if (requestType === UserInputType.SELECT_THEME) {
                userPromptDiv.textContent = "以下のテーマ案から1つ選択してください。各テーマは編集も可能です。";
                const themes = data.themes;
                if (themes && themes.length > 0) {
                    themes.forEach((theme, index) => {
                        const div = document.createElement('div');
                        div.className = 'mb-3 p-3 border rounded bg-gray-50';

                        const radioId = `theme_option_${index}`;
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = 'theme_selection';
                        radio.id = radioId;
                        radio.value = index;
                        radio.className = 'mr-2';
                        if (index === 0) radio.checked = true;

                        const label = document.createElement('label');
                        label.htmlFor = radioId;
                        label.className = 'font-semibold';
                        label.textContent = `テーマ案 ${index + 1}`;
                        div.appendChild(radio);
                        div.appendChild(label);

                        // タイトル編集
                        const titleInputId = `theme_title_edit_${index}`;
                        const titleLabel = document.createElement('label');
                        titleLabel.htmlFor = titleInputId; titleLabel.className = 'block text-sm font-medium text-gray-700 mt-1'; titleLabel.textContent = 'タイトル:';
                        const titleInput = document.createElement('input');
                        titleInput.type = 'text'; titleInput.id = titleInputId; titleInput.value = theme.title;
                        titleInput.className = 'mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm';
                        div.appendChild(titleLabel);
                        div.appendChild(titleInput);

                        // 説明編集
                        const descTextareaId = `theme_desc_edit_${index}`;
                        const descLabel = document.createElement('label');
                        descLabel.htmlFor = descTextareaId; descLabel.className = 'block text-sm font-medium text-gray-700 mt-1'; descLabel.textContent = '説明:';
                        const descTextarea = document.createElement('textarea');
                        descTextarea.id = descTextareaId; descTextarea.value = theme.description;
                        descTextarea.rows = 2;
                        descTextarea.className = 'mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm';
                        div.appendChild(descLabel);
                        div.appendChild(descTextarea);

                        // キーワード編集
                        const keywordsInputId = `theme_keywords_edit_${index}`;
                        const keywordsLabel = document.createElement('label');
                        keywordsLabel.htmlFor = keywordsInputId; keywordsLabel.className = 'block text-sm font-medium text-gray-700 mt-1'; keywordsLabel.textContent = 'キーワード (カンマ区切り):';
                        const keywordsInput = document.createElement('input');
                        keywordsInput.type = 'text'; keywordsInput.id = keywordsInputId; keywordsInput.value = theme.keywords.join(', ');
                        keywordsInput.className = 'mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm';
                        div.appendChild(keywordsLabel);
                        div.appendChild(keywordsInput);
                        
                        interactionOptionsDiv.appendChild(div);
                    });

                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'mt-4 flex space-x-2';

                    const selectButton = document.createElement('button');
                    selectButton.textContent = 'このテーマで決定';
                    selectButton.className = 'bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded';
                    selectButton.onclick = () => {
                        const selectedRadio = document.querySelector('input[name=\"theme_selection\"]:checked');
                        if (selectedRadio) {
                            sendClientResponse(UserInputType.SELECT_THEME, { selected_index: parseInt(selectedRadio.value) });
                        }
                    };
                    buttonContainer.appendChild(selectButton);

                    const editButton = document.createElement('button');
                    editButton.textContent = '編集した内容で決定';
                    editButton.className = 'bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded';
                    editButton.onclick = () => {
                        const selectedRadio = document.querySelector('input[name=\"theme_selection\"]:checked');
                        if (selectedRadio) {
                            const themeIndex = selectedRadio.value;
                            const editedTitle = document.getElementById(`theme_title_edit_${themeIndex}`).value;
                            const editedDescription = document.getElementById(`theme_desc_edit_${themeIndex}`).value;
                            const editedKeywords = document.getElementById(`theme_keywords_edit_${themeIndex}`).value.split(',').map(k => k.trim()).filter(k => k);
                            sendClientResponse(UserInputType.EDIT_AND_PROCEED, { 
                                edited_content: { 
                                    title: editedTitle, 
                                    description: editedDescription, 
                                    keywords: editedKeywords 
                                }
                            }); 
                        }
                    };
                    buttonContainer.appendChild(editButton);

                    const regenerateButton = document.createElement('button');
                    regenerateButton.textContent = 'テーマを再生成';
                    regenerateButton.className = 'bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded';
                    regenerateButton.onclick = () => {
                        sendClientResponse(UserInputType.REGENERATE, {});
                    };
                    buttonContainer.appendChild(regenerateButton);
                    interactionOptionsDiv.appendChild(buttonContainer);

                } else {
                    userPromptDiv.textContent = "テーマ案がありませんでした。";
                }
            }
            // --- Handle 'approve_plan' or 'approve_outline' request ---
            else if (requestType === UserInputType.APPROVE_PLAN) {
                userPromptDiv.textContent = "以下のリサーチ計画を確認してください。編集、承認、または再生成が可能です。";
                const plan = data.plan;
                if (plan) {
                    const planDiv = document.createElement('div');
                    planDiv.className = 'mb-3 p-3 border rounded bg-gray-50';
                    
                    // トピック編集
                    const topicLabel = document.createElement('h4');
                    topicLabel.className = 'text-md font-semibold mb-1'; topicLabel.textContent = 'トピック:';
                    const topicInput = document.createElement('input');
                    topicInput.type = 'text'; topicInput.id = 'plan_topic_edit'; topicInput.value = plan.topic;
                    topicInput.className = 'block w-full p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm mb-2';
                    planDiv.appendChild(topicLabel);
                    planDiv.appendChild(topicInput);

                    // クエリ編集
                    const queriesLabel = document.createElement('h4');
                    queriesLabel.className = 'text-md font-semibold mb-1'; queriesLabel.textContent = 'リサーチクエリ:';
                    planDiv.appendChild(queriesLabel);
                    plan.queries.forEach((q, index) => {
                        const queryDiv = document.createElement('div');
                        queryDiv.className = 'mb-2 p-2 border rounded bg-white';
                        
                        const queryInputId = `plan_query_edit_${index}`;
                        const queryInputLabel = document.createElement('label');
                        queryInputLabel.htmlFor = queryInputId; queryInputLabel.textContent = `クエリ ${index + 1}:`;
                        const queryInput = document.createElement('input');
                        queryInput.type = 'text'; queryInput.id = queryInputId; queryInput.value = q.query;
                        queryInput.className = 'mt-1 block w-full p-1 border border-gray-300 rounded-md sm:text-sm';
                        queryDiv.appendChild(queryInputLabel);
                        queryDiv.appendChild(queryInput);

                        const focusInputId = `plan_focus_edit_${index}`;
                        const focusInputLabel = document.createElement('label');
                        focusInputLabel.htmlFor = focusInputId; focusInputLabel.textContent = `フォーカス ${index + 1}:`;
                        const focusInput = document.createElement('input');
                        focusInput.type = 'text'; focusInput.id = focusInputId; focusInput.value = q.focus;
                        focusInput.className = 'mt-1 block w-full p-1 border border-gray-300 rounded-md sm:text-sm';
                        queryDiv.appendChild(focusInputLabel);
                        queryDiv.appendChild(focusInput);
                        planDiv.appendChild(queryDiv);
                    });
                    interactionOptionsDiv.appendChild(planDiv);

                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'mt-4 flex space-x-2';

                    const approveButton = document.createElement('button');
                    approveButton.textContent = 'この計画で承認';
                    approveButton.className = 'bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded';
                    approveButton.onclick = () => sendClientResponse(UserInputType.APPROVE_PLAN, { approved: true });
                    buttonContainer.appendChild(approveButton);

                    const editButton = document.createElement('button');
                    editButton.textContent = '編集した内容で承認';
                    editButton.className = 'bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded';
                    editButton.onclick = () => {
                        const editedTopic = document.getElementById('plan_topic_edit').value;
                        const editedQueries = [];
                        plan.queries.forEach((q, index) => {
                            const editedQuery = document.getElementById(`plan_query_edit_${index}`).value;
                            const editedFocus = document.getElementById(`plan_focus_edit_${index}`).value;
                            editedQueries.push({ query: editedQuery, focus: editedFocus });
                        });
                        sendClientResponse(UserInputType.EDIT_AND_PROCEED, { 
                            edited_content: { topic: editedTopic, queries: editedQueries }
                        });
                    };
                    buttonContainer.appendChild(editButton);

                    const regenerateButton = document.createElement('button');
                    regenerateButton.textContent = '計画を再生成';
                    regenerateButton.className = 'bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded';
                    regenerateButton.onclick = () => sendClientResponse(UserInputType.REGENERATE, {});
                    buttonContainer.appendChild(regenerateButton);
                    interactionOptionsDiv.appendChild(buttonContainer);
                } else {
                    userPromptDiv.textContent = "リサーチ計画のデータがありませんでした。";
                }
            }
            else if (requestType === UserInputType.APPROVE_OUTLINE) {
                userPromptDiv.textContent = "以下のアウトラインを確認してください。編集、承認、または再生成が可能です。";
                const outline = data.outline;
                if (outline) {
                    const outlineDiv = document.createElement('div');
                    outlineDiv.className = 'mb-3 p-3 border rounded bg-gray-50';

                    // タイトル編集
                    const titleLabel = document.createElement('h4');
                    titleLabel.className = 'text-md font-semibold mb-1'; titleLabel.textContent = 'タイトル:';
                    const titleInput = document.createElement('input');
                    titleInput.type = 'text'; titleInput.id = 'outline_title_edit'; titleInput.value = outline.title;
                    titleInput.className = 'block w-full p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm mb-2';
                    outlineDiv.appendChild(titleLabel);
                    outlineDiv.appendChild(titleInput);

                    // トーン編集
                    const toneLabel = document.createElement('h4');
                    toneLabel.className = 'text-md font-semibold mb-1'; toneLabel.textContent = '提案トーン:';
                    const toneInput = document.createElement('input');
                    toneInput.type = 'text'; toneInput.id = 'outline_tone_edit'; toneInput.value = outline.suggested_tone;
                    toneInput.className = 'block w-full p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm mb-2';
                    outlineDiv.appendChild(toneLabel);
                    outlineDiv.appendChild(toneInput);

                    // セクション編集 (トップレベルのみ)
                    const sectionsLabel = document.createElement('h4');
                    sectionsLabel.className = 'text-md font-semibold mb-1'; sectionsLabel.textContent = 'セクション:';
                    outlineDiv.appendChild(sectionsLabel);
                    outline.sections.forEach((section, index) => {
                        const sectionDiv = document.createElement('div');
                        sectionDiv.className = 'mb-2 p-2 border rounded bg-white';
                        sectionDiv.innerHTML = `<p class=\"font-medium text-gray-800\">セクション ${index + 1}</p>`;

                        const headingInputId = `outline_heading_edit_${index}`;
                        const headingLabel = document.createElement('label');
                        headingLabel.htmlFor = headingInputId; headingLabel.textContent = '見出し:';
                        const headingInput = document.createElement('input');
                        headingInput.type = 'text'; headingInput.id = headingInputId; headingInput.value = section.heading;
                        headingInput.className = 'mt-1 block w-full p-1 border border-gray-300 rounded-md sm:text-sm';
                        sectionDiv.appendChild(headingLabel);
                        sectionDiv.appendChild(headingInput);

                        const charsInputId = `outline_chars_edit_${index}`;
                        const charsLabel = document.createElement('label');
                        charsLabel.htmlFor = charsInputId; charsLabel.textContent = '推定文字数 (任意):';
                        const charsInput = document.createElement('input');
                        charsInput.type = 'number'; charsInput.id = charsInputId; charsInput.value = section.estimated_chars || '';
                        charsInput.className = 'mt-1 block w-full p-1 border border-gray-300 rounded-md sm:text-sm';
                        sectionDiv.appendChild(charsLabel);
                        sectionDiv.appendChild(charsInput);

                        // サブセクションは表示のみ (編集は今回対象外)
                        if (section.subsections && section.subsections.length > 0) {
                            const subLabel = document.createElement('p');
                            subLabel.className = 'text-sm text-gray-600 mt-1';
                            subLabel.textContent = `サブセクション: ${section.subsections.map(s => s.heading).join(', ')}`;
                            sectionDiv.appendChild(subLabel);
                        }
                        outlineDiv.appendChild(sectionDiv);
                    });
                    interactionOptionsDiv.appendChild(outlineDiv);

                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'mt-4 flex space-x-2';

                    const approveButton = document.createElement('button');
                    approveButton.textContent = 'このアウトラインで承認';
                    approveButton.className = 'bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded';
                    approveButton.onclick = () => sendClientResponse(UserInputType.APPROVE_OUTLINE, { approved: true });
                    buttonContainer.appendChild(approveButton);

                    const editButton = document.createElement('button');
                    editButton.textContent = '編集した内容で承認';
                    editButton.className = 'bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded';
                    editButton.onclick = () => {
                        const editedTitle = document.getElementById('outline_title_edit').value;
                        const editedTone = document.getElementById('outline_tone_edit').value;
                        const editedSections = [];
                        outline.sections.forEach((section, index) => {
                            const editedHeading = document.getElementById(`outline_heading_edit_${index}`).value;
                            const editedCharsStr = document.getElementById(`outline_chars_edit_${index}`).value;
                            const editedSection = {
                                heading: editedHeading,
                                estimated_chars: editedCharsStr ? parseInt(editedCharsStr) : null,
                                subsections: section.subsections // サブセクションは元のものをそのまま渡す (編集対象外)
                            };
                            editedSections.push(editedSection);
                        });
                        sendClientResponse(UserInputType.EDIT_AND_PROCEED, { 
                            edited_content: { title: editedTitle, suggested_tone: editedTone, sections: editedSections }
                        });
                    };
                    buttonContainer.appendChild(editButton);

                    const regenerateButton = document.createElement('button');
                    regenerateButton.textContent = 'アウトラインを再生成';
                    regenerateButton.className = 'bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded';
                    regenerateButton.onclick = () => sendClientResponse(UserInputType.REGENERATE, {});
                    buttonContainer.appendChild(regenerateButton);
                    interactionOptionsDiv.appendChild(buttonContainer);
                } else {
                    userPromptDiv.textContent = "アウトラインのデータがありませんでした。";
                }
            }
            // --- Handle unknown request types ---
            else {
                userPromptDiv.textContent = `不明な入力リクエストタイプ: ${requestType}`;
                console.error("Unknown user input request type:", requestType, "Data:", data);
            }
        }

        // Hide the user interaction panel
        function hideInteraction() {
            userInteractionDiv.classList.add('hidden');
            userPromptDiv.innerHTML = '';
            interactionOptionsDiv.innerHTML = '';
            currentExpectedResponseType = null; // Reset the expected response type
        }

        // Display the final generated article
        function displayFinalArticle(title, htmlContent) {
            finalHtmlContent = htmlContent; // Store for copying
            finalArticleContainer.classList.remove('hidden');
            // Basic sanitization (remove script tags) - consider a proper library for production
            const sanitizedHtml = htmlContent.replace(/<script.*?>.*?<\/script>/gi, '');
            finalArticlePreviewDiv.innerHTML = `<h3 class="text-xl font-semibold mb-3">${title}</h3>${sanitizedHtml}`;
            // Scroll to the final article section
             finalArticleContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // --- Send Client Response Back to Server ---
        function sendClientResponse(responseType, payload) {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                logMessage('WebSocket is not connected.', 'error');
                return;
            }
            const message = {
                type: "client_response",
                response_type: responseType,
                payload: payload
            };
            websocket.send(JSON.stringify(message));
            logMessage(message, 'client', true);
            clearUserInteraction(); // Hide the interaction panel after sending
            currentExpectedResponseType = null; // Reset expected type
        }

        // --- Copy Final HTML to Clipboard ---
        copyHtmlBtn.onclick = () => {
             if (finalHtmlContent) {
                navigator.clipboard.writeText(finalHtmlContent)
                    .then(() => {
                        logMessage('完成記事のHTMLをクリップボードにコピーしました！(Final HTML copied to clipboard!)', 'info');
                    })
                    .catch(err => {
                        logMessage('HTMLのコピーに失敗しました。(Failed to copy HTML.)', 'error');
                        console.error('Clipboard copy failed: ', err);
                    });
            } else {
                 logMessage('コピーするHTMLコンテンツがありません。(No HTML content to copy.)', 'info');
            }
        };

        // --- Initial Setup ---
        // UserInputType EnumをJavaScript側でも利用可能にする (グローバルスコープ)
        const UserInputType = {
            SELECT_PERSONA: "select_persona",
            SELECT_THEME: "select_theme",
            APPROVE_PLAN: "approve_plan",
            APPROVE_OUTLINE: "approve_outline",
            EDIT_AND_PROCEED: "edit_and_proceed",
            REGENERATE: "regenerate"
        };

        switchTab('form'); // Start with the form tab active
        disableInteractionElements(true); // Keep inputs disabled until connected

    </script>
</body>
</html>