version: '3.8'

services:
  # Next.js アプリケーション (開発用)
  dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
      # ビルド時に使用する環境変数を docker-compose.yml から渡す
      args:
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
    container_name: nextjs_dev
    ports:
      - "3000:3000"
    env_file:
      - .env.local # Next.js開発環境用 (クラウドSupabaseの接続情報を含む)
    volumes:
      # ホストのソースコードをコンテナの /app にマウント
      - .:/app
      # node_modules と .next はコンテナ内のものを優先 (ホストとの競合を避ける)
      - /app/node_modules
      - /app/.next
    # depends_on はクラウド版Supabaseを使用するため不要
    networks:
      - app_network
    restart: unless-stopped
    # Dockerfile で CMD が定義されているため、ここでは command は不要

  # Next.js アプリケーション (本番用)
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      # ビルド時に使用する環境変数を docker-compose.yml から渡す
      # これらはビルド時ARGとしてDockerfile内でENVに設定され、最終的にアプリケーションに渡る
      args:
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
        STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
        SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY} # Supabase Service Role Key をビルド引数として追加
    container_name: nextjs_prod
    ports:
      - "3001:3000" # 開発用とポートを分ける場合 (例: 3001)
    env_file:
      - .env.local # Next.js本番環境用 (クラウドSupabaseの接続情報を含む)
    # 本番環境ではボリュームマウントは通常不要。ビルドされたイメージに含まれる。
    networks:
      - app_network
    restart: unless-stopped
    # Dockerfile で CMD が定義されているため、ここでは command は不要

  # Stripe CLI サービス (開発用)
  stripe-cli:
    image: stripe/stripe-cli
    container_name: stripe_cli
    # commandのwebhook-secretオプションは、CLIのバージョンによっては利用できない可能性があります。
    # その場合は、Next.js側のエンドポイントで検証することを推奨します。
    # また、STRIPE_API_KEY環境変数にSTRIPE_SECRET_KEYの値を設定します。
    command: "listen --api-key ${STRIPE_SECRET_KEY} --forward-to dev:3000/api/webhooks"
    env_file:
      - .env.local # Stripe APIキーとWebhookシークレットを含む
    networks:
      - app_network
    depends_on:
      - dev # Next.js (dev) サービスが起動してから開始する
    restart: unless-stopped

# ネットワーク定義
networks:
  app_network:
    driver: bridge

# ボリューム定義 (ローカルSupabaseは使用しないため、DBデータ用ボリュームは不要)
volumes: {} 