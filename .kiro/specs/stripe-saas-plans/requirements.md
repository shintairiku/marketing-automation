# 要件定義書: SaaSプラン制限システム実装

## 1. 概要

このプロジェクトは、マーケティングオートメーションプラットフォームにおいて、現在全アカウントに開放されているSEOTiger機能を、Stripeサブスクリプションプランに基づいてアクセス制御する仕組みを構築することを目的とします。

**背景：**
- 現状：全アカウントがSEOTiger機能にアクセス可能
- 課題：フロントエンドでのWebhook処理による技術的負債
- 目標：SaaS化に向けたプラン別アクセス制御と、バックエンドでの統合データ管理

**解決する課題：**
1. プラン未加入者のSEOTigerアクセス制限
2. Stripe/Supabase/Clerkの統合データ管理
3. 組織プランによる座席管理
4. 技術的負債の解消

## 2. 要件一覧

### 要件1: プラン別アクセス制御システム

**ユーザーストーリー:**
> SEOTiger利用者として、プランに応じてサービス機能にアクセスしたい。なぜなら、公正な料金体系でサービスを利用したいからだ。

**受入基準:**
```gherkin
WHEN 有料プラン加入ユーザーがSEOTigerにアクセスする
THEN システムは通常通り機能へのアクセスを許可すること

WHEN 未加入ユーザーがSEOTigerにアクセスする
THEN システムはプラン加入ページへリダイレクトすること

WHEN @shintairiku.jpドメインのユーザーがアクセスする
THEN システムはプラン状況に関係なくアクセスを許可すること

WHEN プラン期限切れのユーザーがアクセスする
THEN システムは更新ページへリダイレクトすること
```

### 要件2: Stripeサブスクリプション管理

**ユーザーストーリー:**
> 新規ユーザーとして、Stripeを通じてプランに加入したい。なぜなら、安全で信頼性の高い決済システムを利用したいからだ。

**受入基準:**
```gherkin
WHEN 新規ユーザーがルートURLにアクセスする
THEN システムはランディングページを表示すること

WHEN ユーザーがプラン選択を行う
THEN システムはStripe Checkoutページへリダイレクトすること

WHEN Stripe決済が完了する
THEN システムはダッシュボードへリダイレクトすること

WHEN 決済エラーが発生する
THEN システムは適切なエラーメッセージと再試行オプションを表示すること
```

### 要件3: 組織プラン・座席管理システム

**ユーザーストーリー:**
> 組織の管理者として、複数のメンバーにアクセス権を付与したい。なぜなら、チーム全体で効率的にSEOTigerを活用したいからだ。

**受入基準（未確定：ここのメンバーに月額料金を請求する可能性あり）:**
```gherkin
WHEN 各組織管理者が組織プランに加入する
THEN システムは最低2座席からの選択を要求すること

WHEN 組織管理者がメンバーを招待する
THEN システムは購入済み座席数の範囲内で招待を許可すること

WHEN 座席上限に達している状態で新規招待する
THEN システムは追加座席購入へ誘導すること

WHEN メンバーが招待を受諾する
THEN システムは該当メンバーにSEOTigerアクセス権を付与すること
```

### 要件4: バックエンドWebhook統合システム

**ユーザーストーリー:**
> システム管理者として、Stripe/Supabase/Clerkのデータを一元管理したい。なぜなら、データの整合性を保ち、技術的負債を解消したいからだ。

**受入基準:**
```gherkin
WHEN StripeからWebhookが送信される
THEN バックエンドがWebhookを受信し、適切に処理すること

WHEN サブスクリプション状態が変更される
THEN システムはSupabaseとClerkの両方でユーザー状態を更新すること

WHEN JWT認証が実行される
THEN システムは最新のプラン情報を含むトークンを発行すること

WHEN データ不整合が発生する
THEN システムは適切なログ記録とエラー通知を行うこと
```

### 要件5: セキュリティ・パフォーマンス要件

**要求事項:**
- 全てのプラン確認処理は200ms以内に完了すること
- JWT認証はClerkの最新仕様に準拠すること
- WebhookエンドポイントはStripe署名検証を実装すること
- ユーザープライバシー情報は適切に保護されること

**受入基準:**
```gherkin
GIVEN 高トラフィック状況下で
WHEN ユーザーがSEOTigerにアクセスする
THEN アクセス制御判定が200ms以内に完了すること

GIVEN 不正なWebhookリクエストが送信された場合
WHEN システムがWebhookを受信する
THEN システムは署名検証でリクエストを拒否すること

GIVEN JWT有効期限が切れた状態で
WHEN ユーザーが保護されたリソースにアクセスする
THEN システムは適切な再認証フローに誘導すること
```