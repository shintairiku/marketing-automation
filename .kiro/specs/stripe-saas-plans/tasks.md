# 実装計画: SaaSプラン制限システム実装

> このドキュメントは、設計書に基づいてStripe/Supabase/Clerk統合によるSaaSプラン制限システムの開発タスクを洗い出し、管理するためのものです。要件定義書と設計書の内容を実装可能な単位に分割し、各タスクの関連要件を明記しています。

## 機能1: データベーススキーマ拡張とマイグレーション

### 1. プラン管理データベース設計と実装
> 既存のSupabaseスキーマに、サブスクリプション管理、組織管理、座席管理のテーブルを追加します。

- [ ] **1.1. サブスクリプション管理テーブルの作成**
  > `subscriptions` テーブルをSupabaseマイグレーションで作成し、Stripe連携に必要なフィールドを定義します。
  >
  > **関連要件:** 要件2 (Stripeサブスクリプション管理), 要件4 (バックエンドWebhook統合)

- [ ] **1.2. 組織管理テーブルの作成**
  > `organizations` および `organization_members` テーブルを作成し、チームプランの座席管理を実現します。
  >
  > **関連要件:** 要件3 (組織プラン・座席管理)

- [ ] **1.3. RLS (Row Level Security) ポリシーの実装**
  > ユーザーが自身のサブスクリプション情報のみアクセス可能になるよう、適切なRLSポリシーを設定します。
  >
  > **関連要件:** 要件1 (プラン別アクセス制御), 要件5 (セキュリティ要件)

- [ ] **1.4. インデックス最適化とパフォーマンス調整**
  > 頻繁に参照されるクエリパターンに対するインデックスを作成し、200ms以内のレスポンス時間を実現します。
  >
  > **関連要件:** 要件5 (パフォーマンス要件)

## 機能2: バックエンドWebhook統合システム

### 2. FastAPI Webhookエンドポイント実装
> フロントエンドからバックエンドへのWebhook処理移行により、技術的負債を解消し、データ整合性を向上させます。

- [ ] **2.1. StripeWebhookエンドポイントの作成**
  > FastAPIに `/api/webhooks/stripe` エンドポイントを実装し、署名検証とイベント処理を行います。
  >
  > **関連要件:** 要件4 (バックエンドWebhook統合), 要件5 (セキュリティ要件)

- [ ] **2.2. サブスクリプションイベント処理ロジック**
  > `customer.subscription.created/updated/deleted` イベントを処理し、Supabaseとの同期を行います。
  >
  > **関連要件:** 要件2 (Stripeサブスクリプション管理), 要件4 (バックエンドWebhook統合)

- [ ] **2.3. Clerkメタデータ同期機能**
  > サブスクリプション変更時に、ClerkのユーザーメタデータをJWT拡張クレームとして更新します。
  >
  > **関連要件:** 要件1 (プラン別アクセス制御), 要件4 (バックエンドWebhook統合)

- [ ] **2.4. エラーハンドリングとリトライメカニズム**
  > Webhook処理失敗時の適切なエラーレスポンス、ログ記録、リトライ処理を実装します。
  >
  > **関連要件:** 要件4 (バックエンドWebhook統合), 要件5 (セキュリティ要件)

### 3. プラン確認API実装
> ユーザーの現在のサブスクリプション状態をリアルタイムで確認するAPIを提供します。

- [ ] **3.1. サブスクリプション状態取得エンドポイント**
  > `/api/subscription/status` エンドポイントを実装し、JWT検証とプラン情報取得を行います。
  >
  > **関連要件:** 要件1 (プラン別アクセス制御)

- [ ] **3.2. 組織メンバー管理API**
  > 組織への招待、メンバー一覧取得、座席管理のAPIエンドポイントを実装します。
  >
  > **関連要件:** 要件3 (組織プラン・座席管理)

## 機能3: フロントエンドアクセス制御システム

### 4. Next.js Middleware アクセス制御実装
> Next.js 15のMiddleware機能を活用し、ルートレベルでのアクセス制御を実現します。

- [ ] **4.1. プラン制御Middlewareの実装**
  > `/tools/**` と `/generate/**` ルートに対するプラン別アクセス制御ミドルウェアを実装します。
  >
  > **関連要件:** 要件1 (プラン別アクセス制御)

- [ ] **4.2. JWT拡張クレーム処理**
  > Clerkから取得するJWTの拡張クレーム（プラン情報）を解析し、アクセス可否を判定します。
  >
  > **関連要件:** 要件1 (プラン別アクセス制御), 要件4 (JWT認証)

- [ ] **4.3. 管理者ドメイン特別処理**
  > `@shintairiku.jp` ドメインユーザーに対する無制限アクセス権を実装します。
  >
  > **関連要件:** 要件1 (プラン別アクセス制御)

- [ ] **4.4. アクセス拒否時のリダイレクト処理**
  > 未加入ユーザーのアクセス拒否時に、適切なプライシングページへリダイレクトします。
  >
  > **関連要件:** 要件1 (プラン別アクセス制御), 要件2 (Stripeサブスクリプション管理)

### 5. ランディングページとプライシング実装
> ルートURLをランディングページとし、Stripeチェックアウトへの導線を実装します。

- [ ] **5.1. ランディングページ (/) の実装**
  > 仮LPとして動作するランディングページを実装し、プラン紹介とCTAボタンを配置します。
  >
  > **関連要件:** 要件2 (Stripeサブスクリプション管理)

- [ ] **5.2. プライシングページ (/pricing) の実装**
  > 個人プラン・チームプランの料金表示とStripe Checkoutへの遷移を実装します。
  >
  > **関連要件:** 要件2 (Stripeサブスクリプション管理), 要件3 (組織プラン)

- [ ] **5.3. Stripe Checkout統合**
  > プラン選択からStripe Checkoutページへのシームレスな遷移を実装します。
  >
  > **関連要件:** 要件2 (Stripeサブスクリプション管理)

- [ ] **5.4. 決済成功後のダッシュボードリダイレクト**
  > Stripe決済完了後、ダッシュボードへの自動リダイレクトを実装します。
  >
  > **関連要件:** 要件2 (Stripeサブスクリプション管理)

## 機能4: 組織プラン・座席管理機能

### 6. 組織管理画面実装
> チームプランでの座席管理、メンバー招待、権限管理機能を実装します。

- [ ] **6.1. 組織ダッシュボード画面の実装**
  > 座席使用状況、メンバー一覧、プラン情報を表示する管理画面を実装します。
  >
  > **関連要件:** 要件3 (組織プラン・座席管理)

- [ ] **6.2. メンバー招待機能の実装**
  > 組織オーナーがメンバーを招待できるフォームとメール送信機能を実装します。
  >
  > **関連要件:** 要件3 (組織プラン・座席管理)

- [ ] **6.3. 座席追加購入機能**
  > 座席上限到達時の追加座席購入フローをStripe統合で実装します。
  >
  > **関連要件:** 要件3 (組織プラン・座席管理), 要件2 (Stripeサブスクリプション管理)

- [ ] **6.4. メンバー権限管理**
  > 組織内でのロール（owner/member）管理とアクセス権制御を実装します。
  >
  > **関連要件:** 要件3 (組織プラン・座席管理), 要件1 (プラン別アクセス制御)

## 機能5: 既存システムとの統合・リファクタリング

### 7. レガシーWebhook処理の移行
> フロントエンドに残る既存のWebhook処理をバックエンドに移行し、技術的負債を解消します。

- [ ] **7.1. フロントエンドWebhook処理の特定**
  > 現在フロントエンドで処理されているStripe-Supabase連携部分を特定し、移行対象を洗い出します。
  >
  > **関連要件:** 要件4 (バックエンドWebhook統合)

- [ ] **7.2. バックエンド移行とデータ整合性検証**
  > フロントエンドの処理をバックエンドに移行し、既存データとの整合性を確認します。
  >
  > **関連要件:** 要件4 (バックエンドWebhook統合)

- [ ] **7.3. 旧処理コードの削除とクリーンアップ**
  > 移行完了後、不要になったフロントエンドのWebhook処理コードを削除します。
  >
  > **関連要件:** 要件4 (バックエンドWebhook統合)

### 8. SEOTiger機能の保護実装
> 既存のSEOTiger機能にプラン制限を適用し、適切なアクセス制御を実装します。

- [ ] **8.1. SEOTigerルートの保護**
  > `/tools/seo-tiger/**` ルートにプランチェック機能を追加します。
  >
  > **関連要件:** 要件1 (プラン別アクセス制御)

- [ ] **8.2. 機能レベルでのアクセス制御**
  > 記事生成、画像生成などの個別機能に対するプラン制限を実装します。
  >
  > **関連要件:** 要件1 (プラン別アクセス制御)

- [ ] **8.3. アクセス拒否時のUX改善**
  > プラン制限に引っかかった場合の適切なメッセージ表示とアップグレード導線を実装します。
  >
  > **関連要件:** 要件1 (プラン別アクセス制御)

## 全般タスク

### 9. テストと品質保証

- [ ] **9.1. Webhook処理のテストケース作成**
  > Stripe Webhookの各イベント（成功・失敗・リトライ）に対する自動テストを実装します。
  >
  > **関連要件:** 要件4 (バックエンドWebhook統合), 要件5 (セキュリティ要件)

- [ ] **9.2. アクセス制御ロジックのテスト**
  > プラン別のアクセス制御、組織権限、管理者権限のテストケースを作成します。
  >
  > **関連要件:** 要件1 (プラン別アクセス制御), 要件3 (組織プラン)

- [ ] **9.3. エンドツーエンドテストシナリオ**
  > サインアップ〜プラン加入〜SEOTigerアクセスまでの全フローのE2Eテストを実装します。
  >
  > **関連要件:** 要件2 (Stripeサブスクリプション管理)

### 10. インフラ・セキュリティ・監視

- [ ] **10.1. Webhook署名検証の実装**
  > Stripeからのリクエストが正当であることを確認する署名検証を実装します。
  >
  > **関連要件:** 要件5 (セキュリティ要件)

- [ ] **10.2. パフォーマンス監視とアラート設定**
  > プラン確認処理時間、Webhook処理成功率の監視とアラート設定を行います。
  >
  > **関連要件:** 要件5 (パフォーマンス要件)

- [ ] **10.3. ログ記録とAudit Trailの実装**
  > サブスクリプション変更、アクセス制御判定のログ記録システムを実装します。
  >
  > **関連要件:** 要件4 (バックエンドWebhook統合), 要件5 (セキュリティ要件)

### 11. ドキュメント・運用

- [ ] **11.1. API仕様書の更新**
  > 新しく追加されるAPIエンドポイントの仕様書を作成・更新します。
  >
  > **関連要件:** 全要件

- [ ] **11.2. プラン変更・座席管理の運用手順書作成**
  > 顧客サポートのためのプラン変更、座席追加の操作手順書を作成します。
  >
  > **関連要件:** 要件3 (組織プラン・座席管理)

- [ ] **11.3. 障害対応・復旧手順書**
  > Webhook処理エラー、決済エラー時の対応手順を文書化します。
  >
  > **関連要件:** 要件4 (バックエンドWebhook統合)