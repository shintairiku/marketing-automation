# 要件定義書

## はじめに

この文書は、マーケティング自動化プラットフォームのマスター管理者認証と内部運用ダッシュボードの実装要件を概説します。このシステムは、サービスプロバイダー管理者が内部プラットフォーム運用、システム監視、インフラ管理、およびサービスプロバイダービジネス運用を管理するための安全なアクセス制御を提供します。

マスター管理者システムは、顧客管理よりも内部サービスプロバイダー運用に焦点を当て、システムヘルス監視、インフラ管理、内部設定、サービスデプロイメント管理、およびサービスプロバイダーの意思決定のためのビジネスインテリジェンスを含みます。

## 要件

### 要件1: Clerk組織ベース管理者認証

**ユーザーストーリー:** プラットフォーム管理者として、Google Workspaceドメインの許可された担当者にアクセスを制限するために、検証済みドメイン制限付きClerk組織メンバーシップを使用して認証したい。

#### 受入基準

1. 管理者がサインインを試みる時、システムは指定されたClerk組織（org_31qpu3arGjKdiatiavEP9E7H3LV）のメンバーであることを検証すること
2. ユーザーが組織メンバーシップなしで認証を試みる時、Clerkは自動的に認証試行を拒否すること
3. ユーザーが検証済みドメインアカウントで認証する時、Clerkは検証済み「shintairiku.jp」ドメインを使用して自動的にドメイン検証を処理すること
4. JWT トークン検証が有効な時、システムはトークン署名と組織メンバーシップクレームを検証すること
5. 未認可ユーザーがアクセスを試みる時、システムは適切なエラーメッセージと共に403 Forbiddenレスポンスを返すこと
6. 認証が成功した時、システムは管理者権限フラグを設定し、監査ログエントリを作成すること

### 要件2: 管理者認可ミドルウェア

**ユーザーストーリー:** システムアーキテクトとして、すべての管理者操作が適切に保護され、監査されるように、管理者エンドポイント用の集中認可システムを必要としている。

#### 受入基準

1. 管理者エンドポイントがアクセスされる時、システムは@require_adminデコレーターを使用してClerk組織メンバーシップを検証すること
2. 組織メンバーシップ検証が失敗した時、システムは403 Forbiddenレスポンスを返すこと
3. 管理者操作が実行される時、システムは自動的にすべてのアクションを監査システムにログ記録すること
4. JWTトークンが無効または期限切れの時、システムは適切なエラーコードでリクエストを拒否すること
5. 管理者ミドルウェアが適用される時、システムはユーザーコンテキストと組織メンバーシップを抽出し、エンドポイントで利用可能にすること

### 要件3: マスター管理者内部運用ダッシュボード

**ユーザーストーリー:** サービスプロバイダー管理者として、プラットフォームのヘルス、デプロイメントステータス、およびビジネス運用を監視できるように、ダッシュボードで内部システム運用とインフラメトリックスを表示したい。

#### 受入基準

1. マスター管理者ダッシュボードにアクセスする時、システムはインフラヘルスメトリックス（CPU、メモリ、データベースパフォーマンス）を表示すること
2. システムメトリックスを表示する時、システムはAPIレスポンス時間、エラー率、サービス可用性を表示すること
3. ~~デプロイメントを監視する時、システムはデプロイメントステータス、バージョン情報、ロールバック機能を表示すること~~
4. ビジネスメトリックスをチェックする時、システムは収益トレンド、コスト分析、収益性メトリックスを表示すること
5. サービスヘルスを表示する時、システムは外部サービスステータス（Clerk、Stripe、GCP、Supabase）を表示すること
6. ダッシュボードデータにアクセスする時、システムはリアルタイム監視のために2分ごとにメトリックスを自動更新すること
7. ダッシュボードが読み込まれる時、システムは1秒以内に重要アラートとシステムステータスを表示すること

### 要件4: システム設定管理

**ユーザーストーリー:** サービスプロバイダー管理者として、プラットフォームの動作を制御し、変更を安全にデプロイできるように、内部システム設定と機能フラグを管理したい。

#### 受入基準

1. システム設定を表示する時、システムは環境変数、機能フラグ、サービス設定を表示すること
2. ~~WHEN updating configurations THEN the system SHALL support real-time updates without service restart where possible~~
3. ~~WHEN managing feature flags THEN the system SHALL allow enabling/disabling features with percentage rollouts~~
4. ~~WHEN configuring services THEN the system SHALL validate configuration changes before applying~~
5. ~~WHEN deploying configuration changes THEN the system SHALL provide rollback capabilities for failed changes~~
6. ~~WHEN exporting configurations THEN the system SHALL generate backup files for disaster recovery~~
7. ~~WHEN performing configuration operations THEN the system SHALL log all changes to the audit system~~

### 要件5: インフラおよびサービス管理

**ユーザーストーリー:** サービスプロバイダー管理者として、プラットフォームの信頼性とパフォーマンスを確保できるように、インフラサービスとデプロイメントを管理したい。

#### 受入基準

1. インフラステータスを表示する時、システムはすべての重要コンポーネントのサービスヘルスを表示すること
2. ~~デプロイメントを管理する時、システムはデプロイメント、ロールバック、ヘルスチェックのトリガーを許可すること~~
3. サービスを監視する時、システムはデータベース、API、外部統合のリアルタイムメトリックスを表示すること
4. ~~インフラをスケールする時、システムは自動スケールとリソース割り当てのコントロールを提供すること~~
5. ~~インシデントを処理する時、システムはインシデント管理ツールとコミュニケーションチャンネルを提供すること~~
6. ~~サービスをメンテナンスする時、システムはユーザー通知付きのメンテナンスウィンドウをスケジュールし、追跡すること~~

### 要件6: 監査ログシステム

**ユーザーストーリー:** コンプライアンス担当者として、セキュリティ監査記録を維持し、問題を調査できるように、すべての管理操作を詳細情報とともにログとして記録したい。

#### 受入基準

1. 任意の管理者操作が実行される時、システムは詳細な監査ログエントリを作成すること
2. 管理者アクションをログ記録する時、システムはタイムスタンプ、管理者ユーザーID、アクションタイプ、対象リソース、変更内容を記録すること
3. 監査ログが作成される時、システムはIPアドレス、ユーザーエージェント、セッション情報を含めること
4. ~~監査ログを表示する時、システムはフィルタリングと検索機能を提供すること~~
5. 監査データが保存される時、システムは適切な保持ポリシーで改ざん防止ログ記録を保証すること
6. ~~重要な操作が発生する時、システムはセキュリティ監視のためのリアルタイムアラートを生成すること~~

### 要件7: 管理者APIインフラ

**ユーザーストーリー:** フロントエンド開発者として、信頼性の高い管理インターフェースを構築できるように、一貫性があり、よく文書化された管理者APIを必要としている。

#### 受入基準

1. 管理者APIが呼び出される時、システムは適切なHTTPステータスコードと一貫したレスポンス形式を返すこと
2. APIエラーが発生する時、システムは機密情報を暴露することなく詳細なエラーメッセージを提供すること
3. ~~API文書が生成される時、システムは自動的にOpenAPI仕様を作成すること~~
4. ~~レート制限が適用される時、システムは通常操作を許可しながらアビューズから管理者エンドポイントを保護すること~~
5. APIレスポンスが返される時、システムは管理者フロントエンドアクセス用の適切なCORSヘッダーを含めること

### 要件8: ビジネスインテリジェンスと分析

**ユーザーストーリー:** サービスプロバイダー管理者として、プラットフォームの成長と最適化について情報に基づいた意思決定を行えるように、ビジネスインテリジェンスと分析データにアクセスしたい。

#### 受入基準

1. ビジネス分析にアクセスする時、システムは収益トレンド、コスト分析、利益マージンを表示すること
2. 使用状況分析を表示する時、システムはAPI使用パターン、機能採用率、パフォーマンスメトリックスを表示すること
3. コストを分析する時、システムはサービスと使用パターン別にインフラコストを分解すること
4. ~~成長を予測する時、システムはキャパシティプランニング用の予測分析を提供すること~~
5. ~~レポートを生成する時、システムはステークホルダーコミュニケーション用のエクスポート可能なレポートを作成すること~~

### 要件9: セキュリティとパフォーマンス

**ユーザーストーリー:** セキュリティ管理者として、機密な管理操作が適切に保護されるように、管理者システムがエンタープライズセキュリティ基準を満たすことを必要としている。

#### 受入基準

1. 管理者セッションが作成される時、システムは適切なセッションタイムアウトと更新を実装すること
2. ~~機密操作が実行される時、システムは追加の確認ダイアログを必要とすること~~
3. データベースクエリが実行される時、システムは適切なインデックシングとクエリ最適化を使用すること
4. 管理者ページが読み込まれる時、システムは95%のリクエストを500ms未満のレスポンス時間で達成すること
5. 同時管理者ユーザーがシステムにアクセスする時、システムは最大10同時管理者セッションを処理すること
6. セキュリティ脆弱性が検出される時、システムは高重要度の脆弱性をゼロにすること